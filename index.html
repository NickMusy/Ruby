<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UFRFC Budget Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .summary-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal-overlay, .page {
            transition: opacity 0.3s ease-in-out;
        }
        .tooltip-container {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            cursor: pointer;
        }
        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            font-weight: normal;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Dashboard Page -->
    <div id="dashboard-page" class="page container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">University of Florida Rugby</h1>
            <p class="text-xl text-gray-600">Club Financial Tracker</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="summary-card bg-white p-6 rounded-xl shadow-md border border-gray-200 flex items-center">
                <div class="bg-green-100 p-4 rounded-full mr-4"><i class="fas fa-arrow-up text-3xl text-green-600"></i></div>
                <div class="flex-1 min-w-0 overflow-hidden"><h2 class="text-gray-500 text-lg">Total Revenue</h2><p id="total-revenue" class="text-3xl font-bold text-green-600">$0.00</p></div>
            </div>
            <div class="summary-card bg-white p-6 rounded-xl shadow-md border border-gray-200 flex items-center">
                <div class="bg-red-100 p-4 rounded-full mr-4"><i class="fas fa-arrow-down text-3xl text-red-600"></i></div>
                <div class="flex-1 min-w-0 overflow-hidden"><h2 class="text-gray-500 text-lg">Total Expenses</h2><p id="total-expenses" class="text-3xl font-bold text-red-600">$0.00</p></div>
            </div>
            <div class="summary-card bg-white p-6 rounded-xl shadow-md border border-gray-200 flex items-center">
                <div class="bg-blue-100 p-4 rounded-full mr-4"><i class="fas fa-balance-scale text-3xl text-blue-600"></i></div>
                <div class="flex-1 min-w-0 overflow-hidden"><h2 class="text-gray-500 text-lg">Net Balance</h2><p id="net-balance" class="text-3xl font-bold text-blue-600">$0.00</p></div>
            </div>
        </div>

        <div class="flex justify-center space-x-4 mb-8">
            <button id="add-revenue-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105"><i class="fas fa-plus-circle mr-2"></i> Add Revenue</button>
            <button id="add-expense-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105"><i class="fas fa-minus-circle mr-2"></i> Add Expense</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <h3 class="text-2xl font-semibold mb-4 text-green-700">Recent Revenue</h3>
                <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-50 border-b"><th class="p-4">Date</th><th class="p-4">Source</th><th class="p-4 text-right">Amount</th><th class="p-4 text-center">Actions</th></tr></thead><tbody id="revenue-table-body"></tbody></table></div>
                <div id="view-all-revenue-container" class="text-center mt-4 hidden"><button data-page="revenue" class="view-all-btn text-gray-500 hover:text-gray-800 font-bold p-2 rounded-full"><i class="fas fa-ellipsis-h"></i></button></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <h3 class="text-2xl font-semibold mb-4 text-red-700">Recent Expenses</h3>
                <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="bg-gray-50 border-b"><th class="p-4">Date</th><th class="p-4">Category</th><th class="p-4 text-right">Amount</th><th class="p-4 text-center">Actions</th></tr></thead><tbody id="expense-table-body"></tbody></table></div>
                <div id="view-all-expenses-container" class="text-center mt-4 hidden"><button data-page="expense" class="view-all-btn text-gray-500 hover:text-gray-800 font-bold p-2 rounded-full"><i class="fas fa-ellipsis-h"></i></button></div>
            </div>
        </div>
    </div>

    <!-- Full List Page -->
    <div id="list-page" class="page container mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <header class="flex items-center mb-8">
            <button id="back-to-dashboard-btn" class="text-blue-500 hover:text-blue-700 font-bold p-2 rounded-full mr-4"><i class="fas fa-arrow-left text-2xl"></i></button>
            <h1 id="list-page-title" class="text-4xl font-bold text-gray-800">All Transactions</h1>
        </header>
        <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
            <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr id="list-page-header" class="bg-gray-50 border-b"></tr></thead><tbody id="list-page-body"></tbody></table></div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transaction-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md m-4 transform transition-transform scale-95">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add Transaction</h2>
            <form id="transaction-form">
                <input type="hidden" id="transaction-type">
                <div class="mb-4"><label for="transaction-date" class="block text-gray-700 mb-2">Date</label><input type="date" id="transaction-date" class="w-full p-3 border rounded-lg" required></div>
                <div class="mb-4"><label id="source-category-label" for="transaction-source-category" class="block text-gray-700 mb-2">Source/Category</label><input type="text" id="transaction-source-category" class="w-full p-3 border rounded-lg" required></div>
                <div class="mb-4"><label for="transaction-description" class="block text-gray-700 mb-2">Description / Notes (Optional)</label><textarea id="transaction-description" class="w-full p-3 border rounded-lg" rows="3"></textarea></div>
                <div class="mb-4"><label for="transaction-amount" class="block text-gray-700 mb-2">Amount</label><input type="number" id="transaction-amount" class="w-full p-3 border rounded-lg" step="0.01" min="0" required></div>
                <div class="mb-6"><label class="block text-gray-700 mb-2">Payment Type</label><div class="flex items-center space-x-4"><label class="flex items-center"><input type="radio" name="paymentType" value="One-Time" class="form-radio" checked><span class="ml-2">One-Time</span></label><label class="flex items-center"><input type="radio" name="paymentType" value="Recurring" class="form-radio"><span class="ml-2">Recurring</span></label></div></div>
                <div class="flex justify-end space-x-4"><button type="button" id="cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button><button type="submit" id="save-btn" class="text-white font-bold py-2 px-6 rounded-lg">Save</button></div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        function initializeAppTracker() {
            const firebaseConfig = { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID", storageBucket: "YOUR_STORAGE_BUCKET", messagingSenderId: "YOUR_MESSAGING_SENDER_ID", appId: "YOUR_APP_ID" };
            let app, db, auth;
            try {
                const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
                app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
            } catch (e) { console.error("Firebase init error:", e); return; }

            const elements = {
                totalRevenue: document.getElementById('total-revenue'),
                totalExpenses: document.getElementById('total-expenses'),
                netBalance: document.getElementById('net-balance'),
                revenueTableBody: document.getElementById('revenue-table-body'),
                expenseTableBody: document.getElementById('expense-table-body'),
                modal: document.getElementById('transaction-modal'),
                modalTitle: document.getElementById('modal-title'),
                transactionForm: document.getElementById('transaction-form'),
                transactionTypeInput: document.getElementById('transaction-type'),
                sourceCategoryLabel: document.getElementById('source-category-label'),
                saveBtn: document.getElementById('save-btn'),
                dashboardPage: document.getElementById('dashboard-page'),
                listPage: document.getElementById('list-page'),
                listPageTitle: document.getElementById('list-page-title'),
                listPageHeader: document.getElementById('list-page-header'),
                listPageBody: document.getElementById('list-page-body'),
                viewAllRevenueContainer: document.getElementById('view-all-revenue-container'),
                viewAllExpensesContainer: document.getElementById('view-all-expenses-container'),
            };

            let allRevenues = [], allExpenses = [];
            let listenersAttached = false;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'ufrfc-default';
            const RECENT_LIMIT = 10;

            const openModal = (type) => {
                elements.transactionForm.reset();
                elements.transactionTypeInput.value = type;
                if (type === 'revenue') {
                    elements.modalTitle.textContent = 'Add Revenue';
                    elements.sourceCategoryLabel.textContent = 'Source';
                    elements.saveBtn.className = 'bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg';
                } else {
                    elements.modalTitle.textContent = 'Add Expense';
                    elements.sourceCategoryLabel.textContent = 'Category';
                    elements.saveBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg';
                }
                elements.modal.classList.remove('hidden');
                setTimeout(() => {
                    elements.modal.classList.remove('opacity-0');
                    elements.modal.querySelector('div').classList.remove('scale-95');
                }, 10);
            };

            const closeModal = () => {
                elements.modal.classList.add('opacity-0');
                elements.modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => elements.modal.classList.add('hidden'), 300);
            };

            const switchPage = (pageName) => {
                document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
                if (pageName === 'dashboard') {
                    elements.dashboardPage.classList.remove('hidden');
                } else {
                    elements.listPage.classList.remove('hidden');
                    renderListPage(pageName);
                }
            };

            const renderListPage = (type) => {
                const isRevenue = type === 'revenue';
                const data = isRevenue ? allRevenues : allExpenses;
                const title = isRevenue ? 'All Revenue' : 'All Expenses';
                const headerText = isRevenue ? 'Source' : 'Category';
                elements.listPageTitle.textContent = title;
                elements.listPageHeader.innerHTML = `<th class="p-4">Date</th><th class="p-4">${headerText}</th><th class="p-4 text-right">Amount</th><th class="p-4 text-center">Actions</th>`;
                renderTable(elements.listPageBody, data, type, false);
            };

            document.getElementById('add-revenue-btn').addEventListener('click', () => openModal('revenue'));
            document.getElementById('add-expense-btn').addEventListener('click', () => openModal('expense'));
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            elements.modal.addEventListener('click', (e) => { if (e.target === elements.modal) closeModal(); });
            document.querySelectorAll('.view-all-btn').forEach(btn => btn.addEventListener('click', (e) => switchPage(e.currentTarget.dataset.page)));
            document.getElementById('back-to-dashboard-btn').addEventListener('click', () => switchPage('dashboard'));

            onAuthStateChanged(auth, user => {
                if (user && !listenersAttached) {
                    attachListeners();
                    listenersAttached = true;
                } else if (!user) {
                    listenersAttached = false;
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (token) signInWithCustomToken(auth, token).catch(e => console.error("Custom token sign-in failed:", e));
                    else signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed:", e));
                }
            });

            const adjustFontSize = (element) => {
                const parent = element.parentElement;
                if (!parent) return;
                element.style.fontSize = '';
                let currentFontSize = parseFloat(window.getComputedStyle(element).fontSize);
                while (element.scrollWidth > parent.clientWidth && currentFontSize > 10) {
                    currentFontSize--;
                    element.style.fontSize = `${currentFontSize}px`;
                }
            };

            function attachListeners() {
                const revenueCollection = collection(db, `artifacts/${appId}/public/data/revenue`);
                const expensesCollection = collection(db, `artifacts/${appId}/public/data/expenses`);

                onSnapshot(revenueCollection, (snapshot) => {
                    allRevenues = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(b.date) - new Date(a.date));
                    updateUI();
                }, (error) => console.error("Error fetching revenue:", error));
                onSnapshot(expensesCollection, (snapshot) => {
                    allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(b.date) - new Date(a.date));
                    updateUI();
                }, (error) => console.error("Error fetching expenses:", error));
            }

            const updateUI = () => {
                renderTable(elements.revenueTableBody, allRevenues, 'revenue', true);
                renderTable(elements.expenseTableBody, allExpenses, 'expense', true);

                elements.viewAllRevenueContainer.style.display = allRevenues.length > RECENT_LIMIT ? 'block' : 'none';
                elements.viewAllExpensesContainer.style.display = allExpenses.length > RECENT_LIMIT ? 'block' : 'none';

                const totalRevenue = allRevenues.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
                const totalExpenses = allExpenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
                const netBalance = totalRevenue - totalExpenses;

                elements.totalRevenue.textContent = formatCurrency(totalRevenue);
                elements.totalExpenses.textContent = formatCurrency(totalExpenses);
                elements.netBalance.textContent = formatCurrency(netBalance);
                elements.netBalance.style.color = netBalance >= 0 ? '#10B981' : '#EF4444';

                adjustFontSize(elements.totalRevenue);
                adjustFontSize(elements.totalExpenses);
                adjustFontSize(elements.netBalance);
            };

            const renderTable = (tbody, data, type, limit) => {
                tbody.innerHTML = '';
                const dataToShow = limit ? data.slice(0, RECENT_LIMIT) : data;
                if (dataToShow.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-500">No transactions yet.</td></tr>`;
                    return;
                }
                dataToShow.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    const paymentTypeBadge = item.paymentType === 'Recurring' ? `<span class="ml-2 text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">Recurring</span>` : `<span class="ml-2 text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-gray-600 bg-gray-200">One-Time</span>`;
                    const descriptionIcon = item.description ? `<div class="tooltip-container"><i class="fas fa-info-circle text-gray-400"></i><span class="tooltip-text">${item.description}</span></div>` : '';
                    row.innerHTML = `
                        <td class="p-4">${new Date(item.date).toLocaleDateString()}</td>
                        <td class="p-4"><span>${item.source || item.category || ''}</span>${paymentTypeBadge}${descriptionIcon}</td>
                        <td class="p-4 text-right font-medium">${formatCurrency(item.amount)}</td>
                        <td class="p-4 text-center"><button data-id="${item.id}" data-type="${type}" class="delete-btn text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></td>`;
                    tbody.appendChild(row);
                });
            };

            document.body.addEventListener('click', async (e) => {
                const target = e.target.closest('.delete-btn');
                if (!target) return;
                const id = target.dataset.id;
                const type = target.dataset.type;
                if (!id || !type) return;

                if (confirm('Are you sure you want to delete this transaction?')) {
                    try {
                        const collectionName = type === 'revenue' ? 'revenue' : 'expenses';
                        const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}/${id}`);
                        await deleteDoc(docRef);
                    } catch (error) {
                        console.error("Error deleting transaction: ", error);
                        alert("Failed to delete transaction.");
                    }
                }
            });

            elements.transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const type = elements.transactionTypeInput.value;
                const newTransaction = {
                    date: document.getElementById('transaction-date').value,
                    amount: parseFloat(document.getElementById('transaction-amount').value),
                    description: document.getElementById('transaction-description').value,
                    paymentType: document.querySelector('input[name="paymentType"]:checked').value,
                    createdAt: new Date().toISOString()
                };
                if (type === 'revenue') {
                    newTransaction.source = document.getElementById('transaction-source-category').value;
                } else {
                    newTransaction.category = document.getElementById('transaction-source-category').value;
                }
                
                try {
                    const collectionRef = type === 'revenue' ? collection(db, `artifacts/${appId}/public/data/revenue`) : collection(db, `artifacts/${appId}/public/data/expenses`);
                    await addDoc(collectionRef, newTransaction);
                    closeModal();
                } catch (error) {
                    console.error("Error adding transaction: ", error);
                    alert("Failed to save transaction.");
                }
            });

            const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
            window.addEventListener('resize', () => {
                adjustFontSize(elements.totalRevenue);
                adjustFontSize(elements.totalExpenses);
                adjustFontSize(elements.netBalance);
            });
        }
        initializeAppTracker();
    </script>
</body>
</html>

